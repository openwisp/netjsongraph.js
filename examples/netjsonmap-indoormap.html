<!DOCTYPE html>
<html>
  <head>
    <title>Indoor map</title>
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
      integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
      crossorigin=""
    />
    <!-- theme can be easily customized via css -->
    <link href="../src/css/netjsongraph-theme.css" rel="stylesheet" />
    <link href="../src/css/netjsongraph.css" rel="stylesheet" />

    <link rel="preload" href="./data/floorplan.png" as="image" />
    <style>
      .njg-tooltip {
        background: rgba(0, 0, 0, 0.75) !important;
        border: none !important;
      }

      .njg-tooltip-key,
      .njg-tooltip-value {
        color: #fff;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript" src="../dist/netjsongraph.min.js"></script>
    <script>
      /*
          The demo is used to show how to set indoor map.
          Mainly the operation of leaflet.
          See `onLoad` below for details.
      */
      const graph = new NetJSONGraph("./data/netjsonmap-indoormap.json", {
        render: "map",
        // set map initial state.
        mapOptions: {
          center: [48.577, 18.539],
          zoom: 5.5,
          zoomSnap: 0.3,
          minZoom: 3.5,
          maxZoom: 9,
          nodeConfig: {
            label: {
              offset: [0, -10],
              fontSize: "14px",
              fontWeight: "bold",
              color: "#D9644D",
            },
            animation: false,
          },
          linkConfig: {
            linkStyle: {
              width: 4,
            },
            animation: false,
          },
        },

        // Convert to internal json format
        prepareData: function (data) {
          data.nodes.map((node) => {
            node.label = node.name;
            node.properties = Object.assign(node.properties || {}, {
              location: node.location,
            });
          });
        },

        onLoad: function presentIndoormap() {
          const gui = this.utils.getGUI(this);
          gui.init();
          if (this.config.metadata) {
            gui.createAboutContainer(graph);
            gui.sideBar.classList.add("hidden");
            this.utils.updateMetadata.call(this);
          }
          if (this.config.switchMode) {
            gui.renderModeSelector.onclick = () => {
              if (this.config.render === this.utils.mapRender) {
                this.config.render = this.utils.graphRender;
                const canvasContainer = this.echarts
                  .getZr()
                  .painter.getViewportRoot().parentNode;
                this.echarts.clear();
                this.utils.graphRender(this.data, this);
                canvasContainer.style.background =
                  // eslint-disable-next-line no-underscore-dangle
                  this.echarts.getZr()._backgroundColor;
              } else {
                this.echarts.clear();
                this.config.render = this.utils.mapRender;
                this.utils.mapRender(this.data, this);
              }
            };
          }
          this.config.onClickElement = (type, data) => {
            let nodeLinkData;
            if (type === "node") {
              nodeLinkData = this.utils.nodeInfo(data);
            } else {
              nodeLinkData = this.utils.linkInfo(data);
            }
            gui.getNodeLinkInfo(type, nodeLinkData);
            gui.sideBar.classList.remove("hidden");
          };

          const netjsonmap = this.leaflet;
          const image = new Image();
          image.src = "./data/floorplan.png";

          const aspectRatio = image.width / image.height;
          const height = 700;
          const width = aspectRatio * height;
          const southWest = {lat: 53, lng: 2};
          const swPixel = netjsonmap.latLngToContainerPoint(southWest);
          const nePixel = swPixel.add(new L.Point(width, height));
          const northEast = netjsonmap.containerPointToLatLng(nePixel);

          const bounds = new L.LatLngBounds(southWest, northEast);
          netjsonmap.setMaxBounds(bounds);

          // remove the geographic map
          netjsonmap.eachLayer((layer) => {
            if (layer._url) {
              netjsonmap.removeLayer(layer);
            }
          });
          // add indoormap image
          L.imageOverlay(image, bounds).addTo(netjsonmap);
          this.utils.hideLoading();
        },
      });

      graph.render();
    </script>
  </body>
</html>
